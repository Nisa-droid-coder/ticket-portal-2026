<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSD2024 UPM - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        /* Your existing styles - keep them exactly as they are */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            padding: 0 40px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-text h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .logo-text .event-title {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .admin-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .admin-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-info i {
            font-size: 1.2rem;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-content h3 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .stat-content p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .stat-card:nth-child(1) .stat-icon {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #2196F3, #0D47A1);
        }
        
        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
        }
        
        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #9C27B0, #6A1B9A);
        }
        
        .main-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-header h2 {
            color: #2c3e50;
            font-size: 1.8rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3d8b40;
        }
        
        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #0b7dda;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-warning {
            background-color: #FF9800;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #EF6C00;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #444;
            font-size: 0.9rem;
        }
        
        .filter-control {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95rem;
            min-width: 200px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background-color: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-paid {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-pending {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .status-cancelled {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .ticket-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .participants-list {
            max-height: 120px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .participant-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .participant-item:last-child {
            border-bottom: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: #2c3e50;
            font-size: 1.5rem;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detail-group {
            margin-bottom: 20px;
        }
        
        .detail-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
        }
        
        .detail-value {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pagination-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .pagination-btn:hover:not(.active) {
            background-color: #e9ecef;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-data i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 992px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .admin-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .admin-info {
                width: 100%;
                justify-content: center;
            }
            
            .search-filter {
                flex-direction: column;
            }
            
            .filter-control {
                min-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header-content {
                padding: 0 20px;
            }
            
            .logo-text h1 {
                font-size: 2rem;
            }
            
            .stat-card {
                flex-direction: column;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .booking-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <header>
        <div class="header-content">
            <div class="logo-container">
                <div class="logo-text">
                    <h1>YSD2026 UPM</h1>
                    <div class="event-title">Admin Dashboard</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <div class="admin-info" id="adminInfo">
                    <i class="fas fa-user-shield"></i>
                    <span>Loading...</span>
                </div>
                <button class="btn btn-secondary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalBookings">0</h3>
                    <p>Total Bookings</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalParticipants">0</h3>
                    <p>Total Participants</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalRevenue">RM 0.00</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <h3 id="avgBooking">RM 0.00</h3>
                    <p>Average Booking Value</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="section-header">
                <h2><i class="fas fa-list-alt"></i> Booking Management</h2>
                <div class="controls">
                    <button class="btn btn-primary" id="exportCsvBtn">
                        <i class="fas fa-file-csv"></i> Export to CSV
                    </button>
                    <button class="btn btn-secondary" id="addBookingBtn">
                        <i class="fas fa-plus"></i> Add Booking
                    </button>
                </div>
            </div>
            
            <div class="search-filter">
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" class="filter-control" placeholder="Search by name, email, reference...">
                </div>
                
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" class="filter-control">
                        <option value="all">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="ticketTypeFilter">Ticket Type</label>
                    <select id="ticketTypeFilter" class="filter-control">
                        <option value="all">All Types</option>
                        <option value="single">Single Ticket</option>
                        <option value="group">Group Package</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="dateFilter">Date Range</label>
                    <select id="dateFilter" class="filter-control">
                        <option value="all">All Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table id="bookingsTable">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Contact Person</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Ticket Type</th>
                            <th>Participants</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Booking Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody">
                        <!-- Bookings will be dynamically added here -->
                    </tbody>
                </table>
                
                <div class="no-data" id="noDataMessage" style="display: none;">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No bookings found</h3>
                    <p>Try adjusting your search or filter to find what you're looking for.</p>
                </div>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be dynamically added here -->
            </div>
        </div>
        
        <footer>
            <p>YSD2026 Universiti Putra Malaysia Admin Dashboard &copy; 2026. All rights reserved.</p>
            <p>For support, contact: admin.ysd2026@upm.edu.my | +603-9769 5678</p>
        </footer>
    </div>
    
    <!-- Booking Details Modal -->
    <div class="modal" id="bookingDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Booking Details</h3>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="bookingDetailsBody">
                <!-- Booking details will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <!-- Add Booking Modal -->
    <div class="modal" id="addBookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Booking</h3>
                <button class="close-btn" id="closeAddModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addBookingForm">
                    <div class="booking-details">
                        <div class="detail-group">
                            <label for="newContactName">Contact Person *</label>
                            <input type="text" id="newContactName" class="form-control" placeholder="Enter full name" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newContactEmail">Email Address *</label>
                            <input type="email" id="newContactEmail" class="form-control" placeholder="Enter email address" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newContactPhone">Phone Number *</label>
                            <input type="tel" id="newContactPhone" class="form-control" placeholder="Enter phone number" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newTicketType">Ticket Type *</label>
                            <select id="newTicketType" class="form-control" required>
                                <option value="single">Single Ticket (RM 65.00)</option>
                                <option value="group">Group Package (RM 180.00)</option>
                            </select>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newQuantity">Quantity *</label>
                            <input type="number" id="newQuantity" class="form-control" value="1" min="1" max="20" required>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newStatus">Status *</label>
                            <select id="newStatus" class="form-control" required>
                                <option value="pending">Pending</option>
                                <option value="paid">Paid</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="detail-group">
                            <label for="newAmount">Amount (RM) *</label>
                            <input type="number" id="newAmount" class="form-control" value="65.00" step="0.01" required>
                        </div>
                        
                        <div class="detail-group" style="grid-column: span 2;">
                            <label for="newParticipants">Participants (One per line, format: Name, IC, Age)</label>
                            <textarea id="newParticipants" class="form-control" rows="4" placeholder="John Doe, 010101-01-0101, 10&#10;Jane Smith, 020202-02-0202, 9"></textarea>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn btn-secondary" id="cancelAddBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION - REPLACE WITH YOUR OWN
        // ============================================
        const firebaseConfig = {
  apiKey: "AIzaSyABaOMohXrju_OelcUQLAxlIBy809ob3uI",
  authDomain: "ysd2026-upm-tickets.firebaseapp.com",
  projectId: "ysd2026-upm-tickets",
  storageBucket: "ysd2026-upm-tickets.firebasestorage.app",
  messagingSenderId: "350674755825",
  appId: "1:350674755825:web:143f8ee11a2fb568080950",
  measurementId: "G-Y4R80MP8P2"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let allBookings = [];
        let filteredBookings = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentBookingDetails = null;

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const bookingsTableBody = document.getElementById('bookingsTableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        const totalBookingsElement = document.getElementById('totalBookings');
        const totalParticipantsElement = document.getElementById('totalParticipants');
        const totalRevenueElement = document.getElementById('totalRevenue');
        const avgBookingElement = document.getElementById('avgBooking');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const ticketTypeFilter = document.getElementById('ticketTypeFilter');
        const dateFilter = document.getElementById('dateFilter');
        const bookingDetailsModal = document.getElementById('bookingDetailsModal');
        const addBookingModal = document.getElementById('addBookingModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const addBookingBtn = document.getElementById('addBookingBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const addBookingForm = document.getElementById('addBookingForm');
        const newTicketType = document.getElementById('newTicketType');
        const newQuantity = document.getElementById('newQuantity');
        const newAmount = document.getElementById('newAmount');
        const adminInfo = document.getElementById('adminInfo');

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('en-US', options);
        }

        // ============================================
        // CHECK AUTHENTICATION
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                // Not logged in, redirect to login
                window.location.href = 'login.html';
                return;
            }
            
            // Update admin info
            adminInfo.innerHTML = `
                <i class="fas fa-user-shield"></i>
                <span>${user.email} | Last Login: ${formatDateTime(new Date())}</span>
            `;
            
            // Load bookings
            await loadBookings();
        });

        // ============================================
        // LOAD BOOKINGS FROM FIRESTORE
        // ============================================
        async function loadBookings() {
            showLoading();
            
            try {
                const snapshot = await db.collection('bookings')
                    .orderBy('bookingDate', 'desc')
                    .get();
                
                allBookings = [];
                snapshot.forEach(doc => {
                    allBookings.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                filteredBookings = [...allBookings];
                currentPage = 1;
                
                renderTable();
                updateStats();
                updatePagination();
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                alert('Error loading bookings. Please refresh the page.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // RENDER TABLE
        // ============================================
        function renderTable() {
            bookingsTableBody.innerHTML = '';
            
            if (filteredBookings.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredBookings.length);
            const currentBookings = filteredBookings.slice(startIndex, endIndex);
            
            currentBookings.forEach(booking => {
                const row = document.createElement('tr');
                
                // Format participants list
                const participantsList = (booking.participants || []).map(p => 
                    `<div class="participant-item">${p.name} (IC: ${p.ic}, Age: ${p.age})</div>`
                ).join('');
                
                // Determine status badge class
                let statusClass = 'status-pending';
                if (booking.status === 'paid') statusClass = 'status-paid';
                if (booking.status === 'cancelled') statusClass = 'status-cancelled';
                
                // Determine ticket type display
                const ticketTypeText = booking.ticketType === 'group' ? 'Group Package' : 'Single Ticket';
                const ticketTypeClass = booking.ticketType === 'group' ? 'ticket-type' : '';
                
                row.innerHTML = `
                    <td><strong>${booking.bookingId || 'N/A'}</strong></td>
                    <td>${booking.contactPerson || 'N/A'}</td>
                    <td>${booking.email || 'N/A'}</td>
                    <td>${booking.phone || 'N/A'}</td>
                    <td><span class="${ticketTypeClass}">${ticketTypeText}</span></td>
                    <td>
                        <div class="participants-list">
                            ${participantsList || '<em>No participants</em>'}
                        </div>
                        <small>${booking.quantity || 0} participant(s)</small>
                    </td>
                    <td><strong>RM ${(booking.amount || 0).toFixed(2)}</strong></td>
                    <td><span class="status-badge ${statusClass}">${(booking.status || 'pending').toUpperCase()}</span></td>
                    <td>${formatDate(booking.bookingDate)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-secondary" onclick="viewBookingDetails('${booking.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-small btn-warning" onclick="editBooking('${booking.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteBooking('${booking.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                bookingsTableBody.appendChild(row);
            });
        }

        // ============================================
        // UPDATE STATISTICS
        // ============================================
        function updateStats() {
            // Total bookings
            totalBookingsElement.textContent = filteredBookings.length;
            
            // Total participants
            const totalParticipants = filteredBookings.reduce((sum, booking) => sum + (booking.quantity || 0), 0);
            totalParticipantsElement.textContent = totalParticipants;
            
            // Total revenue (only from paid bookings)
            const paidBookings = filteredBookings.filter(b => b.status === 'paid');
            const totalRevenue = paidBookings.reduce((sum, booking) => sum + (booking.amount || 0), 0);
            totalRevenueElement.textContent = `RM ${totalRevenue.toFixed(2)}`;
            
            // Average booking value
            const avgBooking = paidBookings.length > 0 ? totalRevenue / paidBookings.length : 0;
            avgBookingElement.textContent = `RM ${avgBooking.toFixed(2)}`;
        }

        // ============================================
        // FILTER BOOKINGS
        // ============================================
        function filterBookings() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilterValue = statusFilter.value;
            const ticketTypeFilterValue = ticketTypeFilter.value;
            const dateFilterValue = dateFilter.value;
            
            filteredBookings = allBookings.filter(booking => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (booking.contactPerson && booking.contactPerson.toLowerCase().includes(searchTerm)) ||
                    (booking.email && booking.email.toLowerCase().includes(searchTerm)) ||
                    (booking.phone && booking.phone.toLowerCase().includes(searchTerm)) ||
                    (booking.bookingId && booking.bookingId.toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = statusFilterValue === 'all' || booking.status === statusFilterValue;
                
                // Ticket type filter
                const matchesTicketType = ticketTypeFilterValue === 'all' || booking.ticketType === ticketTypeFilterValue;
                
                // Date filter
                let matchesDate = true;
                if (dateFilterValue !== 'all' && booking.bookingDate) {
                    const bookingDate = booking.bookingDate.toDate ? booking.bookingDate.toDate() : new Date(booking.bookingDate);
                    const today = new Date();
                    
                    if (dateFilterValue === 'today') {
                        matchesDate = bookingDate.toDateString() === today.toDateString();
                    } else if (dateFilterValue === 'week') {
                        const startOfWeek = new Date(today);
                        startOfWeek.setDate(today.getDate() - today.getDay());
                        matchesDate = bookingDate >= startOfWeek;
                    } else if (dateFilterValue === 'month') {
                        matchesDate = bookingDate.getMonth() === today.getMonth() && 
                                     bookingDate.getFullYear() === today.getFullYear();
                    }
                }
                
                return matchesSearch && matchesStatus && matchesTicketType && matchesDate;
            });
            
            currentPage = 1;
            renderTable();
            updateStats();
            updatePagination();
        }

        // ============================================
        // UPDATE PAGINATION
        // ============================================
        function updatePagination() {
            const paginationElement = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredBookings.length / itemsPerPage);
            
            if (totalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                                onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="pagination-btn">...</span>`;
                }
            }
            
            // Next button
            paginationHTML += `
                <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationElement.innerHTML = paginationHTML;
        }

        // ============================================
        // CHANGE PAGE
        // ============================================
        function changePage(page) {
            if (page < 1 || page > Math.ceil(filteredBookings.length / itemsPerPage)) return;
            
            currentPage = page;
            renderTable();
            window.scrollTo(0, 0);
        }

        // ============================================
        // VIEW BOOKING DETAILS
        // ============================================
        async function viewBookingDetails(bookingId) {
            showLoading();
            
            try {
                const doc = await db.collection('bookings').doc(bookingId).get();
                if (!doc.exists) {
                    alert('Booking not found');
                    return;
                }
                
                const booking = { id: doc.id, ...doc.data() };
                currentBookingDetails = booking;
                
                const detailsBody = document.getElementById('bookingDetailsBody');
                
                // Format participants list
                const participantsList = (booking.participants || []).map(p => 
                    `<tr>
                        <td>${p.name}</td>
                        <td>${p.ic}</td>
                        <td>${p.age}</td>
                    </tr>`
                ).join('');
                
                // Format payment method
                let paymentMethodText = 'FPX UPM';
                if (booking.paymentMethod === 'card') paymentMethodText = 'Credit/Debit Card';
                if (booking.paymentMethod === 'ewallet') paymentMethodText = 'E-Wallet';
                
                detailsBody.innerHTML = `
                    <div class="booking-details">
                        <div class="detail-group">
                            <label>Booking ID</label>
                            <div class="detail-value">${booking.bookingId || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Contact Person</label>
                            <div class="detail-value">${booking.contactPerson || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Email Address</label>
                            <div class="detail-value">${booking.email || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Phone Number</label>
                            <div class="detail-value">${booking.phone || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Ticket Type</label>
                            <div class="detail-value">${booking.ticketType === 'group' ? 'Group Package (3 Tickets)' : 'Single Ticket'}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Quantity</label>
                            <div class="detail-value">${booking.quantity || 0} ticket(s)</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Amount</label>
                            <div class="detail-value"><strong>RM ${(booking.amount || 0).toFixed(2)}</strong></div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Status</label>
                            <div class="detail-value">
                                <span class="status-badge ${booking.status === 'paid' ? 'status-paid' : booking.status === 'pending' ? 'status-pending' : 'status-cancelled'}">
                                    ${(booking.status || 'pending').toUpperCase()}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Payment Method</label>
                            <div class="detail-value">${paymentMethodText}</div>
                        </div>
                        
                        <div class="detail-group">
                            <label>Booking Date</label>
                            <div class="detail-value">${formatDateTime(booking.bookingDate)}</div>
                        </div>
                        
                        <div class="detail-group" style="grid-column: span 2;">
                            <label>Participants (${booking.quantity || 0})</label>
                            <div class="detail-value">
                                <table style="width: 100%; margin-top: 10px;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>IC/Passport</th>
                                            <th>Age</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${participantsList || '<tr><td colspan="3">No participants</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <button class="btn btn-secondary" onclick="document.getElementById('bookingDetailsModal').style.display='none'">Close</button>
                        <button class="btn btn-primary" onclick="printBookingDetails()">
                            <i class="fas fa-print"></i> Print Details
                        </button>
                    </div>
                `;
                
                bookingDetailsModal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading booking details:', error);
                alert('Error loading booking details');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // PRINT BOOKING DETAILS
        // ============================================
        function printBookingDetails() {
            if (!currentBookingDetails) return;
            
            const booking = currentBookingDetails;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Booking Details - ${booking.bookingId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .header h1 { color: #2c3e50; margin-bottom: 5px; }
                        .info { margin-bottom: 20px; }
                        .info-row { display: flex; margin-bottom: 10px; }
                        .label { font-weight: bold; width: 200px; }
                        .participants-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .participants-table th, .participants-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        .participants-table th { background-color: #f5f5f5; }
                        .footer { text-align: center; margin-top: 40px; font-size: 0.9rem; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>YOUTH SPORTS DAY 2024</h1>
                        <h2>Booking Details</h2>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="info">
                        <div class="info-row">
                            <div class="label">Booking ID:</div>
                            <div>${booking.bookingId || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Contact Person:</div>
                            <div>${booking.contactPerson || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Email:</div>
                            <div>${booking.email || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Phone:</div>
                            <div>${booking.phone || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Ticket Type:</div>
                            <div>${booking.ticketType === 'group' ? 'Group Package' : 'Single Ticket'}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Quantity:</div>
                            <div>${booking.quantity || 0}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Amount:</div>
                            <div><strong>RM ${(booking.amount || 0).toFixed(2)}</strong></div>
                        </div>
                        <div class="info-row">
                            <div class="label">Status:</div>
                            <div>${(booking.status || 'pending').toUpperCase()}</div>
                        </div>
                        <div class="info-row">
                            <div class="label">Booking Date:</div>
                            <div>${formatDateTime(booking.bookingDate)}</div>
                        </div>
                    </div>
                    
                    <h3>Participants (${booking.quantity || 0})</h3>
                    <table class="participants-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>IC/Passport</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(booking.participants || []).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td>${p.ic}</td>
                                    <td>${p.age}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>YSD2024 Universiti Putra Malaysia</p>
                        <p>For inquiries: admin.ysd2024@upm.edu.my | +603-9769 5678</p>
                    </div>
                    
                    <div class="no-print" style="text-align: center; margin-top: 20px;">
                        <button onclick="window.print()">Print</button>
                        <button onclick="window.close()">Close</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ============================================
        // EDIT BOOKING
        // ============================================
        async function editBooking(bookingId) {
            const newStatus = prompt('Enter new status (paid/pending/cancelled):');
            if (!newStatus) return;
            
            if (!['paid', 'pending', 'cancelled'].includes(newStatus)) {
                alert('Invalid status. Please enter paid, pending, or cancelled.');
                return;
            }
            
            showLoading();
            
            try {
                await db.collection('bookings').doc(bookingId).update({
                    status: newStatus
                });
                
                alert('Booking status updated successfully!');
                await loadBookings(); // Reload data
                
            } catch (error) {
                console.error('Error updating booking:', error);
                alert('Error updating booking. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // DELETE BOOKING
        // ============================================
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                return;
            }
            
            showLoading();
            
            try {
                await db.collection('bookings').doc(bookingId).delete();
                alert('Booking deleted successfully!');
                await loadBookings(); // Reload data
                
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // ADD NEW BOOKING
        // ============================================
        async function addNewBooking(e) {
            e.preventDefault();
            
            // Get form values
            const contactName = document.getElementById('newContactName').value;
            const email = document.getElementById('newContactEmail').value;
            const phone = document.getElementById('newContactPhone').value;
            const ticketType = document.getElementById('newTicketType').value;
            const quantity = parseInt(document.getElementById('newQuantity').value);
            const status = document.getElementById('newStatus').value;
            const amount = parseFloat(document.getElementById('newAmount').value);
            const participantsText = document.getElementById('newParticipants').value;
            
            // Validate participants
            const participants = [];
            if (participantsText.trim()) {
                const lines = participantsText.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(part => part.trim());
                    if (parts.length >= 3) {
                        participants.push({
                            name: parts[0],
                            ic: parts[1],
                            age: parseInt(parts[2])
                        });
                    }
                }
            }
            
            // Generate booking ID
            const bookingId = 'YSD-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            
            showLoading();
            
            try {
                // Create booking data
                const bookingData = {
                    bookingId: bookingId,
                    contactPerson: contactName,
                    email: email,
                    phone: phone,
                    ticketType: ticketType,
                    quantity: quantity,
                    participants: participants,
                    amount: amount,
                    status: status,
                    paymentMethod: 'fpx',
                    bookingDate: firebase.firestore.FieldValue.serverTimestamp(),
                    eventDate: '2026-06-13'
                };
                
                // Save to Firestore
                await db.collection('bookings').add(bookingData);
                
                // Reset form
                addBookingForm.reset();
                newAmount.value = '65.00';
                newQuantity.value = '1';
                newQuantity.readOnly = false;
                
                // Close modal
                addBookingModal.style.display = 'none';
                
                // Refresh dashboard
                await loadBookings();
                
                alert(`New booking ${bookingId} has been added successfully!`);
                
            } catch (error) {
                console.error('Error adding booking:', error);
                alert('Error adding booking. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // UPDATE AMOUNT IN ADD BOOKING FORM
        // ============================================
        function updateNewBookingAmount() {
            const ticketType = newTicketType.value;
            const quantity = parseInt(newQuantity.value) || 1;
            
            let amount = 0;
            if (ticketType === 'group') {
                amount = 180.00;
                newQuantity.value = 3;
                newQuantity.min = 3;
                newQuantity.max = 3;
                newQuantity.readOnly = true;
            } else {
                amount = 65.00 * quantity;
                newQuantity.min = 1;
                newQuantity.max = 20;
                newQuantity.readOnly = false;
            }
            
            newAmount.value = amount.toFixed(2);
        }

        // ============================================
        // EXPORT TO CSV
        // ============================================
        function exportToCSV() {
            if (filteredBookings.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for CSV
            const csvData = [];
            
            // Add headers
            csvData.push([
                'Booking ID',
                'Contact Person',
                'Email',
                'Phone',
                'Ticket Type',
                'Quantity',
                'Amount (RM)',
                'Status',
                'Booking Date',
                'Payment Method',
                'Participants Count'
            ]);
            
            // Add booking data
            filteredBookings.forEach(booking => {
                csvData.push([
                    booking.bookingId || 'N/A',
                    booking.contactPerson || 'N/A',
                    booking.email || 'N/A',
                    booking.phone || 'N/A',
                    booking.ticketType === 'group' ? 'Group Package' : 'Single Ticket',
                    booking.quantity || 0,
                    (booking.amount || 0).toFixed(2),
                    booking.status || 'pending',
                    booking.bookingDate ? formatDate(booking.bookingDate) : 'N/A',
                    booking.paymentMethod === 'fpx' ? 'FPX UPM' : 
                    booking.paymentMethod === 'card' ? 'Credit/Debit Card' : 'E-Wallet',
                    booking.quantity || 0
                ]);
            });
            
            // Convert to CSV string
            const csvContent = csvData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `YSD2024_Bookings_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`CSV file with ${filteredBookings.length} bookings has been downloaded.`);
        }

        // ============================================
        // REFRESH DASHBOARD
        // ============================================
        async function refreshDashboard() {
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            await loadBookings();
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }

        // ============================================
        // LOGOUT
        // ============================================
        async function logoutAdmin() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            showLoading();
            
            try {
                await auth.signOut();
                sessionStorage.removeItem('ysd2024_admin');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                hideLoading();
                alert('Error logging out. Please try again.');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Search and filter events
            searchInput.addEventListener('input', filterBookings);
            statusFilter.addEventListener('change', filterBookings);
            ticketTypeFilter.addEventListener('change', filterBookings);
            dateFilter.addEventListener('change', filterBookings);
            
            // Modal close events
            closeModalBtn.addEventListener('click', () => bookingDetailsModal.style.display = 'none');
            closeAddModalBtn.addEventListener('click', () => addBookingModal.style.display = 'none');
            cancelAddBtn.addEventListener('click', () => addBookingModal.style.display = 'none');
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === bookingDetailsModal) {
                    bookingDetailsModal.style.display = 'none';
                }
                if (event.target === addBookingModal) {
                    addBookingModal.style.display = 'none';
                }
            });
            
            // Button events
            refreshBtn.addEventListener('click', refreshDashboard);
            exportCsvBtn.addEventListener('click', exportToCSV);
            addBookingBtn.addEventListener('click', () => addBookingModal.style.display = 'flex');
            logoutBtn.addEventListener('click', logoutAdmin);
            
            // Form events
            addBookingForm.addEventListener('submit', addNewBooking);
            
            // Ticket type change event for new booking form
            newTicketType.addEventListener('change', updateNewBookingAmount);
            newQuantity.addEventListener('change', updateNewBookingAmount);
        });

        // Make functions globally available
        window.changePage = changePage;
        window.viewBookingDetails = viewBookingDetails;
        window.editBooking = editBooking;
        window.deleteBooking = deleteBooking;
        window.printBookingDetails = printBookingDetails;
    </script>
</body>
</html>